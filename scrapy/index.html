<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">Scrapy实战案例——房天下 - dp0d&#39;s blog</title><meta name="Description" content="Scrapy信息检索大作业驱动，爬虫应该是python使用者比较重要的一门技能，学会这个也能进厂了，本项目较为详细，实现不了你打我。"><meta property="og:title" content="Scrapy实战案例——房天下" />
<meta property="og:description" content="Scrapy信息检索大作业驱动，爬虫应该是python使用者比较重要的一门技能，学会这个也能进厂了，本项目较为详细，实现不了你打我。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dp0d.github.io/scrapy/" /><meta property="og:image" content="https://dp0d.github.io/images/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-09T10:40:45+08:00" />
<meta property="article:modified_time" content="2022-04-09T10:40:45+08:00" /><meta property="og:site_name" content="dp0d&#39;s blog" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://dp0d.github.io/images/logo.png"/>

<meta name="twitter:title" content="Scrapy实战案例——房天下"/>
<meta name="twitter:description" content="Scrapy信息检索大作业驱动，爬虫应该是python使用者比较重要的一门技能，学会这个也能进厂了，本项目较为详细，实现不了你打我。"/>
<meta name="application-name" content="dp0d&#39;s blog">
<meta name="apple-mobile-web-app-title" content="dp0d&#39;s blog">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://dp0d.github.io/scrapy/" /><link rel="prev" href="https://dp0d.github.io/frp_by_docker/" /><link rel="next" href="https://dp0d.github.io/lm_pretraining/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript>
    
    
    
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Scrapy实战案例——房天下",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/dp0d.github.io\/scrapy\/"
        },"image": ["https:\/\/dp0d.github.io\/images\/logo.png"],"genre": "posts","keywords": "Scrapy2.6","wordcount":  12415 ,
        "url": "https:\/\/dp0d.github.io\/scrapy\/","datePublished": "2022-04-09T10:40:45+08:00","dateModified": "2022-04-09T10:40:45+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "dp0d","logo": "https:\/\/dp0d.github.io\/images\/logo.png"},"author": {
                "@type": "Person",
                "name": "dp0d"
            },"description": "Scrapy信息检索大作业驱动，爬虫应该是python使用者比较重要的一门技能，学会这个也能进厂了，本项目较为详细，实现不了你打我。"
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme);}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="dp0d&#39;s blog"><span class="header-title-pre"><i class='far fa-edit fa-fw'></i></span>Natural Language Processing</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/charge/"> 充电 </a><a class="menu-item" href="/friends/"> 朋友萌 </a><a class="menu-item" href="/collection/"> 收藏 </a><a class="menu-item" href="/copyright/"> 版权 </a><a class="menu-item" href="/about/"> 关于我 </a><a class="menu-item" href="https://github.com/dp0d" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-select" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="切换主题">
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                        <option value="black">黑色</option>
                        <option value="auto">跟随系统</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="dp0d&#39;s blog"><span class="header-title-pre"><i class='far fa-edit fa-fw'></i></span>Natural Language Processing</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" onclick="return false;" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/charge/" title="">充电</a><a class="menu-item" href="/friends/" title="">朋友萌</a><a class="menu-item" href="/collection/" title="">收藏</a><a class="menu-item" href="/copyright/" title="">版权</a><a class="menu-item" href="/about/" title="">关于我</a><a class="menu-item" href="https://github.com/dp0d" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="#" onclick="return false;" class="menu-item theme-select" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="切换主题">
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                    <option value="black">黑色</option>
                    <option value="auto">跟随系统</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#scrapy框架概览">Scrapy框架概览</a>
      <ul>
        <li><a href="#scrapy结构组成">Scrapy结构组成</a></li>
        <li><a href="#scrapy工作数据流">Scrapy工作数据流</a></li>
      </ul>
    </li>
    <li><a href="#scrapy-安装">Scrapy 安装</a>
      <ul>
        <li><a href="#文档">文档</a></li>
        <li><a href="#环境介绍">环境介绍</a></li>
        <li><a href="#安装流程">安装流程</a></li>
      </ul>
    </li>
    <li><a href="#scrapy基本使用">Scrapy基本使用</a>
      <ul>
        <li><a href="#创建scrapy项目">创建scrapy项目</a></li>
        <li><a href="#创建爬虫注意爬虫名字不要和项目域名相同">创建爬虫，注意爬虫名字不要和项目域名相同</a></li>
        <li><a href="#基本使用">基本使用</a></li>
        <li><a href="#模拟浏览器访问">模拟浏览器访问</a></li>
        <li><a href="#请求和下载设定">请求和下载设定</a></li>
      </ul>
    </li>
    <li><a href="#二手房链接获取爬虫">二手房链接获取爬虫</a>
      <ul>
        <li><a href="#进入链接入口页面">进入链接入口页面</a></li>
        <li><a href="#编写itemspy">编写<code>items.py</code></a>
          <ul>
            <li><a href="#抓取城市入口链接数据类">抓取城市入口链接数据类</a></li>
          </ul>
        </li>
        <li><a href="#建立并编写spiders目录下的esfpy">建立并编写spiders目录下的<code>esf.py</code></a></li>
        <li><a href="#简单爬虫的持久化存储">简单爬虫的持久化存储</a></li>
        <li><a href="#使用scrapy的pipline机制进行持久化存储">使用Scrapy的Pipline机制进行持久化存储。</a></li>
        <li><a href="#至此完成基本的scrapy项目">至此完成基本的Scrapy项目</a></li>
      </ul>
    </li>
    <li><a href="#特定城市二手房概要信息爬虫">特定城市二手房概要信息爬虫</a>
      <ul>
        <li><a href="#矛与盾重定向">矛与盾——重定向</a></li>
        <li><a href="#itempy">Item.py</a></li>
        <li><a href="#esfpy">esf.py</a></li>
        <li><a href="#middlewarespy">middlewares.py</a></li>
        <li><a href="#settingspy">settings.py</a></li>
        <li><a href="#pipelinespy">pipelines.py</a></li>
        <li><a href="#启动爬虫">启动爬虫</a></li>
        <li><a href="#获得爬得数据">获得爬得数据</a></li>
      </ul>
    </li>
    <li><a href="#多城市二手房详情页爬虫">多城市二手房详情页爬虫</a>
      <ul>
        <li><a href="#完整爬取流程">完整爬取流程</a></li>
        <li><a href="#矛与盾">矛与盾</a>
          <ul>
            <li><a href="#ip代理">IP代理</a></li>
            <li><a href="#selenium模拟拖动绕过验证码">selenium模拟拖动，绕过验证码</a></li>
          </ul>
        </li>
        <li><a href="#主要类定义">主要类定义</a>
          <ul>
            <li><a href="#爬虫文件">爬虫文件</a></li>
            <li><a href="#管道文件">管道文件</a></li>
            <li><a href="#item文件">Item文件</a></li>
          </ul>
        </li>
        <li><a href="#爬虫程序运行结果示例">爬虫程序运行结果示例</a>
          <ul>
            <li><a href="#解析示例">解析示例</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Scrapy实战案例——房天下</h1><h2 class="single-subtitle">Scrapy2.6</h2><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="https://github.com/dp0d" title="Author" target="_blank" rel="noopener noreffer author" class="author">dp0d</a>
                </span>&nbsp;<span class="post-category">收录于 </span>&nbsp;<span class="post-category">类别 <a href="/categories/tutorial/"><i class="far fa-folder fa-fw"></i>教程</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-04-09">2022-04-09</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2022-04-09">2022-04-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 12415 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 25 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#scrapy框架概览">Scrapy框架概览</a>
      <ul>
        <li><a href="#scrapy结构组成">Scrapy结构组成</a></li>
        <li><a href="#scrapy工作数据流">Scrapy工作数据流</a></li>
      </ul>
    </li>
    <li><a href="#scrapy-安装">Scrapy 安装</a>
      <ul>
        <li><a href="#文档">文档</a></li>
        <li><a href="#环境介绍">环境介绍</a></li>
        <li><a href="#安装流程">安装流程</a></li>
      </ul>
    </li>
    <li><a href="#scrapy基本使用">Scrapy基本使用</a>
      <ul>
        <li><a href="#创建scrapy项目">创建scrapy项目</a></li>
        <li><a href="#创建爬虫注意爬虫名字不要和项目域名相同">创建爬虫，注意爬虫名字不要和项目域名相同</a></li>
        <li><a href="#基本使用">基本使用</a></li>
        <li><a href="#模拟浏览器访问">模拟浏览器访问</a></li>
        <li><a href="#请求和下载设定">请求和下载设定</a></li>
      </ul>
    </li>
    <li><a href="#二手房链接获取爬虫">二手房链接获取爬虫</a>
      <ul>
        <li><a href="#进入链接入口页面">进入链接入口页面</a></li>
        <li><a href="#编写itemspy">编写<code>items.py</code></a>
          <ul>
            <li><a href="#抓取城市入口链接数据类">抓取城市入口链接数据类</a></li>
          </ul>
        </li>
        <li><a href="#建立并编写spiders目录下的esfpy">建立并编写spiders目录下的<code>esf.py</code></a></li>
        <li><a href="#简单爬虫的持久化存储">简单爬虫的持久化存储</a></li>
        <li><a href="#使用scrapy的pipline机制进行持久化存储">使用Scrapy的Pipline机制进行持久化存储。</a></li>
        <li><a href="#至此完成基本的scrapy项目">至此完成基本的Scrapy项目</a></li>
      </ul>
    </li>
    <li><a href="#特定城市二手房概要信息爬虫">特定城市二手房概要信息爬虫</a>
      <ul>
        <li><a href="#矛与盾重定向">矛与盾——重定向</a></li>
        <li><a href="#itempy">Item.py</a></li>
        <li><a href="#esfpy">esf.py</a></li>
        <li><a href="#middlewarespy">middlewares.py</a></li>
        <li><a href="#settingspy">settings.py</a></li>
        <li><a href="#pipelinespy">pipelines.py</a></li>
        <li><a href="#启动爬虫">启动爬虫</a></li>
        <li><a href="#获得爬得数据">获得爬得数据</a></li>
      </ul>
    </li>
    <li><a href="#多城市二手房详情页爬虫">多城市二手房详情页爬虫</a>
      <ul>
        <li><a href="#完整爬取流程">完整爬取流程</a></li>
        <li><a href="#矛与盾">矛与盾</a>
          <ul>
            <li><a href="#ip代理">IP代理</a></li>
            <li><a href="#selenium模拟拖动绕过验证码">selenium模拟拖动，绕过验证码</a></li>
          </ul>
        </li>
        <li><a href="#主要类定义">主要类定义</a>
          <ul>
            <li><a href="#爬虫文件">爬虫文件</a></li>
            <li><a href="#管道文件">管道文件</a></li>
            <li><a href="#item文件">Item文件</a></li>
          </ul>
        </li>
        <li><a href="#爬虫程序运行结果示例">爬虫程序运行结果示例</a>
          <ul>
            <li><a href="#解析示例">解析示例</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="scrapy框架概览" class="headerLink">
    <a href="#scrapy%e6%a1%86%e6%9e%b6%e6%a6%82%e8%a7%88" class="header-mark"></a>Scrapy框架概览</h2><p>Scrapy使用了Twisted异步网络框架来处理网络通讯，可以加快我们的下载速度，不用自己去实现异步框架，并且包含了各种中间件接口，可以灵活完成各种需求。</p>
<h3 id="scrapy结构组成" class="headerLink">
    <a href="#scrapy%e7%bb%93%e6%9e%84%e7%bb%84%e6%88%90" class="header-mark"></a>Scrapy结构组成</h3><table>
<thead>
<tr>
<th>Components</th>
<th>Introduction</th>
</tr>
</thead>
<tbody>
<tr>
<td>Scrapy Engine</td>
<td>Scrapy引擎负责控制各组件之间的所有数据流，并在特定动作发生时触发事件。</td>
</tr>
<tr>
<td>Scheduler</td>
<td>调度器接收来自引擎的请求并将它们按一定要求排入队列以便后续响应引擎。（爬虫执行过程需要时间，不能同时完成所有任务，因而需要任务队列。）</td>
</tr>
<tr>
<td>Downloader</td>
<td>下载器负责抓取网页并将它们喂给引擎，引擎转而喂给Spider爬虫程序。</td>
</tr>
<tr>
<td>Spider</td>
<td>爬虫是由Scrapy用户自行编写的客制化类，用来解析响应以及提取网页数据项或其他请求。</td>
</tr>
<tr>
<td>Item Pipline</td>
<td>负责处理由爬虫提取的items。典型任务包括清理数据，验证数据以及持续化存储在数据库中等。</td>
</tr>
<tr>
<td>Downloader middlewares</td>
<td>下载中间件是位于引擎和下载器之间的特定钩子程序（可以理解为连接点），用来处理由引擎发往下载器的请求已经来自下载器发回引擎的响应。使用下载中间件的情景如下：<br/>- 在请求发送给下载器之前进行处理（比如就在Scrapy向网页发送请求时）<br/>- 在响应发往爬虫程序时，改写得到的响应。<br/>- 发送一个新的请求而不是将得到的响应发给爬虫程序。<br/>- 在不抓取网页的情况下向爬虫传递一个响应。<br/>- 静默丢弃一些请求。</td>
</tr>
<tr>
<td>Spider middlewares</td>
<td>爬虫程序中间件是位于引擎和爬虫程序之间的特定的钩子程序，它能够处理爬虫程序的输入（发往爬虫程序的响应）以及爬虫程序得到的输出（数据项和请求）。使用爬虫程序中间件的情景如下：<br/>- 后处理爬虫程序回调的输出 - 更改/添加/删除请求或item；<br/>- 后处理启动请求；<br/>- 处理爬虫程序异常；<br/>- 对于一些基于响应内容的请求，调用errback而不是callback。</td>
</tr>
</tbody>
</table>
<h3 id="scrapy工作数据流" class="headerLink">
    <a href="#scrapy%e5%b7%a5%e4%bd%9c%e6%95%b0%e6%8d%ae%e6%b5%81" class="header-mark"></a>Scrapy工作数据流</h3><ul>
<li><strong>简略框架</strong></li>
</ul>
<p><img
        class="lazyload"
        data-src="MD_img/scrapy_architecture_01.png"
        data-srcset="/scrapy/MD_img/scrapy_architecture_01.png, MD_img/scrapy_architecture_01.png 1.5x, /scrapy/MD_img/scrapy_architecture_01.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/scrapy_architecture_01.png"
        title="scrapy_architecture_01"></p>
<ul>
<li><strong>详细框架</strong></li>
</ul>
<p><img
        class="lazyload"
        data-src="MD_img/scrapy_architecture_02.png"
        data-srcset="/scrapy/MD_img/scrapy_architecture_02.png, MD_img/scrapy_architecture_02.png 1.5x, /scrapy/MD_img/scrapy_architecture_02.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/scrapy_architecture_02.png"
        title="scrapy_architecture_02"></p>
<p><strong>Scrapy 的数据流由执行引擎进行控制，进行过程如下（步骤序号对应上图）</strong>：</p>
<ol>
<li><strong>流程开始</strong>，引擎从爬虫程序得到初始的爬取请求。</li>
<li>引擎将Requests放入调度器并请求进行下一个爬取的Requests。</li>
<li>调度器返回下一个Requests给引擎。</li>
<li>引擎将得到的Requests发送给下载器，途径下载器中间件。</li>
<li>在网页完成下载的同时，生成页面的响应并将它发送给引擎，途径下载器中间件。</li>
<li>引擎收到来自下载器的响应并将其发送给爬虫程序处理，途径爬虫程序中间件。</li>
<li>爬虫程序处理得到的响应并将抓取的items和新的Requests返回给引擎，途径爬虫中间件。</li>
<li>引擎发送处理好的items发送给Item Piplines，并将发送处理好的Requests给调度器并请求下一个爬取的Requests。</li>
<li>重复步骤3直到调度器里没有更多的Requests，<strong>流程结束</strong>。</li>
</ol>
<h2 id="scrapy-安装" class="headerLink">
    <a href="#scrapy-%e5%ae%89%e8%a3%85" class="header-mark"></a>Scrapy 安装</h2><h3 id="文档" class="headerLink">
    <a href="#%e6%96%87%e6%a1%a3" class="header-mark"></a>文档</h3><p>官方文档：https://docs.scrapy.org/en/latest</p>
<p>中文维护：http://scrapy-chs.readthedocs.io/zh_CN/latest/index.html</p>
<h3 id="环境介绍" class="headerLink">
    <a href="#%e7%8e%af%e5%a2%83%e4%bb%8b%e7%bb%8d" class="header-mark"></a>环境介绍</h3><p>Ubuntu 21.10,	Python3.10.3，pyenv</p>
<h3 id="安装流程" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85%e6%b5%81%e7%a8%8b" class="header-mark"></a>安装流程</h3><p>pip 更新</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python -m pip install --upgrade pip
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装scrapy</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pip install scrapy
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="scrapy基本使用" class="headerLink">
    <a href="#scrapy%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8" class="header-mark"></a>Scrapy基本使用</h2><p>本次实践的是房天下网站，仅用于学习交流，不作任何商业用途，比如就以二手房为例。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">st=&gt;start: 开始
</span></span><span class="line"><span class="cl">op1=&gt;operation: 进入城市列表页，获取每个城市房源的进入链接
</span></span><span class="line"><span class="cl">op2=&gt;operation: 进入每个城市对应的二手房源列表页面。
</span></span><span class="line"><span class="cl">op3=&gt;operation: 进入列表页每个二手房的详情页。
</span></span><span class="line"><span class="cl">e=&gt;end: 结束
</span></span><span class="line"><span class="cl">st-&gt;op1-&gt;op2-&gt;op3-&gt;e
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="创建scrapy项目" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%bascrapy%e9%a1%b9%e7%9b%ae" class="header-mark"></a>创建scrapy项目</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> ~
</span></span><span class="line"><span class="cl">scrapy startproject scrapy_fang
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="创建爬虫注意爬虫名字不要和项目域名相同" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%ba%e7%88%ac%e8%99%ab%e6%b3%a8%e6%84%8f%e7%88%ac%e8%99%ab%e5%90%8d%e5%ad%97%e4%b8%8d%e8%a6%81%e5%92%8c%e9%a1%b9%e7%9b%ae%e5%9f%9f%e5%90%8d%e7%9b%b8%e5%90%8c" class="header-mark"></a>创建爬虫，注意爬虫名字不要和项目域名相同</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> scrapy_fang
</span></span><span class="line"><span class="cl">scrapy genspider esf esf.fang.com
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="基本使用" class="headerLink">
    <a href="#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8" class="header-mark"></a>基本使用</h3><p>命令行输入scrapy进行查看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">scrapy
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Scrapy 2.6.1 - project: scrapy_fang</p>
<p>Usage:
scrapy <command> [options] [args]</p>
<p>Available commands:
bench         Run quick benchmark test
check         Check spider contracts
commands   <br>
crawl         Run a spider
edit          Edit spider
fetch         Fetch a URL using the Scrapy downloader
genspider     Generate new spider using pre-defined templates
list          List available spiders
parse         Parse URL (using its spider) and print the results
runspider     Run a self-contained spider (without creating a project)
settings      Get settings values
shell         Interactive scraping console
startproject  Create new project
version       Print Scrapy version
view          Open URL in browser, as seen by Scrapy</p>
<p>Use &ldquo;scrapy <command> -h&rdquo; to see more info about a command</p>
</blockquote>
<h3 id="模拟浏览器访问" class="headerLink">
    <a href="#%e6%a8%a1%e6%8b%9f%e6%b5%8f%e8%a7%88%e5%99%a8%e8%ae%bf%e9%97%ae" class="header-mark"></a>模拟浏览器访问</h3><p>设置请求头(模拟浏览器访问)，在settings.py下添加，可以更换，随便打开一个网页，F12查看network，然后找一下User-Agent内容。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">USER_AGENT</span>  <span class="o">=</span> <span class="s1">&#39;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.60 Safari/537.36&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>或者在下载器中间件写入如下类，随机请求头</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserAgentDownloadMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">User_Agents</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (X11; Linux i686; rv:64.0) Gecko/20100101 Firefox/64.0&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.13; ko; rv:1.9.1b2) Gecko/2008&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;1201 Firefox/60.0&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39; Chrome/70.0.3538.77 Safari/537.36&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML like Gecko) Chrome&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;/44.0.2403.155 Safari/537.36&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">USER_AGENT</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">User_Agents</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">USER_AGENT</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>**==不要忘记==**在settings.py里头指定该类为下载器中间件，否则无效，数字543等指定优先级，越小优先级越高。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">DOWNLOADER_MIDDLEWARES</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;scrapy_fang.middlewares.UserAgentDownloadMiddleware&#39;</span><span class="p">:</span> <span class="mi">543</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="请求和下载设定" class="headerLink">
    <a href="#%e8%af%b7%e6%b1%82%e5%92%8c%e4%b8%8b%e8%bd%bd%e8%ae%be%e5%ae%9a" class="header-mark"></a>请求和下载设定</h3><p>在settings.py中写入如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 限制并发Requests数量，默认是16
</span></span><span class="line"><span class="cl">CONCURRENT_REQUESTS = 32
</span></span><span class="line"><span class="cl"># 延时最低为2s
</span></span><span class="line"><span class="cl">DOWNLOAD_DELAY = 1 
</span></span><span class="line"><span class="cl"># 启动[自动限速]
</span></span><span class="line"><span class="cl">AUTOTHROTTLE_ENABLED = True
</span></span><span class="line"><span class="cl"># 开启[自动限速]的debug
</span></span><span class="line"><span class="cl">AUTOTHROTTLE_DEBUG = True
</span></span><span class="line"><span class="cl"># 设置最大下载延时
</span></span><span class="line"><span class="cl">AUTOTHROTTLE_MAX_DELAY = 10 
</span></span><span class="line"><span class="cl"># 设置下载超时
</span></span><span class="line"><span class="cl">DOWNLOAD_TIMEOUT = 15
</span></span><span class="line"><span class="cl"># 限制对该网站的并发请求数
</span></span><span class="line"><span class="cl">CONCURRENT_REQUESTS_PER_DOMAIN = 4 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="二手房链接获取爬虫" class="headerLink">
    <a href="#%e4%ba%8c%e6%89%8b%e6%88%bf%e9%93%be%e6%8e%a5%e8%8e%b7%e5%8f%96%e7%88%ac%e8%99%ab" class="header-mark"></a>二手房链接获取爬虫</h2><h3 id="进入链接入口页面" class="headerLink">
    <a href="#%e8%bf%9b%e5%85%a5%e9%93%be%e6%8e%a5%e5%85%a5%e5%8f%a3%e9%a1%b5%e9%9d%a2" class="header-mark"></a>进入链接入口页面</h3><p><a href="https://www.fang.com/SoufunFamily.htm" target="_blank" rel="noopener noreffer">https://www.fang.com/SoufunFamily.htm</a>  ，测试插件是xpath helper</p>
<p><img
        class="lazyload"
        data-src="MD_img/image-20220504152225594.png"
        data-srcset="/scrapy/MD_img/image-20220504152225594.png, MD_img/image-20220504152225594.png 1.5x, /scrapy/MD_img/image-20220504152225594.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/image-20220504152225594.png"
        title="image-20220504152225594"></p>
<p>正确定位到各城市入口页面</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//*[@id=&#39;senfe&#39;]//tr
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试程序里的xpath路径是否能抓到东西。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">scrapy shell http://www.fang.com/SoufunFamily.htm
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>[s] Available Scrapy objects:
[s]   scrapy     scrapy module (contains scrapy.Request, scrapy.Selector, etc)
[s]   crawler    &lt;scrapy.crawler.Crawler object at 0x7f34bb89eaa0&gt;
[s]   item       {}
[s]   request    &lt;GET <a href="http://www.fang.com/SoufunFamily.htm%3e" target="_blank" rel="noopener noreffer">http://www.fang.com/SoufunFamily.htm></a>
[s]   response   &lt;200 <a href="https://www.fang.com/SoufunFamily.htm%3e" target="_blank" rel="noopener noreffer">https://www.fang.com/SoufunFamily.htm></a>
[s]   settings   &lt;scrapy.settings.Settings object at 0x7f34bb89f3a0&gt;
[s]   spider     &lt;DefaultSpider &lsquo;default&rsquo; at 0x7f34bb2bc760&gt;
[s] Useful shortcuts:
[s]   fetch(url[, redirect=True]) Fetch URL and update local objects (by default, redirects are followed)
[s]   fetch(req)                  Fetch a scrapy.Request and update local objects
[s]   shelp()           Shell help (print this help)
[s]   view(response)    View response in a browser</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&gt;&gt;&gt;response.xpath<span class="o">(</span><span class="s2">&#34;//*[@id=&#39;senfe&#39;]//tr&#34;</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>[<Selector xpath="//*[@id='senfe']//tr" data='<tr id="sffamily_B03_01">\r\n\t\t\t\t<td va...'>, <Selector xpath="//*[@id='senfe']//tr" data='<tr id="sffamily_B03_02">\r\n\t\t\t\t<td wi...'>, <Selector xpath="//*[@id='senfe']//tr" data='<tr id="sffamily_B03_02">\r\n\t\t\t\t<td va...'>, ……</p>
</blockquote>
<p><strong>抓取成功，想要抓取html里的其他内容也可以进行类似的操作，此处不一一列举。</strong></p>
<p>注意xpath返回的是xpath对象组成的列表，而不是单纯的网页源码文本，要想获得内容需要.extrract()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&gt;&gt;&gt;response.xpath(&#34;//*[@id=&#39;senfe&#39;]//tr&#34;).extract()
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>[&rsquo;<tr id="sffamily_B03_01">\r\n\t\t\t\t<td valign="top" class="font01" style="text-align:center;">\xa0</td>\r\n\t\t\t\t<td valign="top"><strong>直辖市</strong></td>\r\n\t\t\t\t<td>\r\n\t\t\t\t\t<a href="http://bj.fang.com/" target="ank" class="red">北京</a> \r\n\t\t\t\t\t<a href="http://sh.fang.com/" target="_blank" class="red">上海</a> \r\n\t\t\t<a href="http://tj.fang.com/" target="_blank" class="red">天津</a> \r\n\t\t\t\t\t<a href="http://cq.fang.com/" targ="_blank" class="red">重庆</a>\r\n\t\t\t\t</td>\r\n\t\t\t</tr>&rsquo;,……</p>
</blockquote>
<p>这样就得到了抓取的网页html源码，每个tr标签是一个列表项~</p>
<h3 id="编写itemspy" class="headerLink">
    <a href="#%e7%bc%96%e5%86%99itemspy" class="header-mark"></a>编写<code>items.py</code></h3><h4 id="抓取城市入口链接数据类" class="headerLink">
    <a href="#%e6%8a%93%e5%8f%96%e5%9f%8e%e5%b8%82%e5%85%a5%e5%8f%a3%e9%93%be%e6%8e%a5%e6%95%b0%e6%8d%ae%e7%b1%bb" class="header-mark"></a>抓取城市入口链接数据类</h4><p>现在，明确我们要从这个页面获得什么数据，显然，我们需要获取，省份，城市，以及该城市二手房页面进入的链接，所以我们需要编写item类，用来暂时存放我们每个元数据的数据字典，scrapy给我们定义好了一个Item类，可以用来创建类字典的数据类型，可以当字典用，后续看。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class UrlItem(scrapy.Item):
</span></span><span class="line"><span class="cl">    # 省份
</span></span><span class="line"><span class="cl">    province = scrapy.Field()
</span></span><span class="line"><span class="cl">    # 城市
</span></span><span class="line"><span class="cl">    city = scrapy.Field()
</span></span><span class="line"><span class="cl">    # 二手房链接
</span></span><span class="line"><span class="cl">    esfhouse_url = scrapy.Field()
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="建立并编写spiders目录下的esfpy" class="headerLink">
    <a href="#%e5%bb%ba%e7%ab%8b%e5%b9%b6%e7%bc%96%e5%86%99spiders%e7%9b%ae%e5%bd%95%e4%b8%8b%e7%9a%84esfpy" class="header-mark"></a>建立并编写spiders目录下的<code>esf.py</code></h3><p>主要属性和方法</p>
<ul>
<li>
<p>name</p>
<blockquote>
<p>定义sipder名字的字符串，必须。</p>
<p>例如，如果spider爬取qq.com，该spider的name通常定义为qq</p>
</blockquote>
</li>
<li>
<p>allowed_domains</p>
<blockquote>
<p>包含了spider允许爬取的域名列表，可选。</p>
</blockquote>
</li>
<li>
<p>start_urls</p>
<blockquote>
<p>初始URL列表。当没有制定特定的URL时，spider将从该列表中进行爬取，必选。</p>
</blockquote>
</li>
<li>
<p>start_requests(self)</p>
<blockquote>
<p>该方法必须返回一个可迭代（iterable）对象。该对象包含了spider用于爬取（默认实现是使用start_urls的url）的第一个Request。</p>
<p>当spider启动爬取并且未指定start_urls，该方法将被调用。</p>
</blockquote>
</li>
<li>
<p>parse(self, response)</p>
<blockquote>
<p>当请求url返回网页没有指定回调函数时，默认的Requests对象回调函数是parse。用来处理网页返回的response，以及生成item和Requests对象。</p>
</blockquote>
</li>
<li>
<p>log(self, message[, level, component])</p>
<blockquote>
<p>使用scrapy.log.msg()方法记录(log)message。</p>
</blockquote>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EsfSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 别名，后续用来其启动爬虫</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;esf&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 允许爬取的页面</span>
</span></span><span class="line"><span class="cl">    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fang.com&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 启动爬取的页面</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://www.fang.com/SoufunFamily.htm&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Scrapy框架默认调用这个方法。response.body是html源码</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span> <span class="o">=</span> <span class="n">UrlItem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取数据的每一行tr，可能一行爲一個省份，也可能多行爲一個省份</span>
</span></span><span class="line"><span class="cl">        <span class="n">trs</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//*[@id=&#39;senfe&#39;]//tr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># print(trs)</span>
</span></span><span class="line"><span class="cl">        <span class="n">city_lis</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">trs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 获取省份的td</span>
</span></span><span class="line"><span class="cl">            <span class="n">tds</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//td[not(@class)]&#34;</span><span class="p">)</span>  <span class="c1"># &#34;not(@class)&#34; ：没有为class赋值的被选取</span>
</span></span><span class="line"><span class="cl">            <span class="n">province_td</span> <span class="o">=</span> <span class="n">tds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># #获取省份的值</span>
</span></span><span class="line"><span class="cl">            <span class="n">province_text</span> <span class="o">=</span> <span class="n">province_td</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># #给省份去掉 多余空格</span>
</span></span><span class="line"><span class="cl">            <span class="n">province_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">province_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 判断省份是否为空的</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">province_text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 将不为空的省份赋值给province</span>
</span></span><span class="line"><span class="cl">                <span class="n">province</span> <span class="o">=</span> <span class="n">province_text</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 除去国外的链接</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">province</span> <span class="o">==</span> <span class="s1">&#39;其它&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 除去直辖市中的重庆和天津，因为在文中有写到</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">province</span> <span class="o">==</span> <span class="s1">&#39;重庆&#39;</span> <span class="ow">or</span> <span class="n">province</span> <span class="o">==</span> <span class="s1">&#39;天津&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;province&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">province</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 获取城市的td</span>
</span></span><span class="line"><span class="cl">            <span class="n">city_td</span> <span class="o">=</span> <span class="n">tds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 获取到城市的a元素</span>
</span></span><span class="line"><span class="cl">            <span class="n">city_links</span> <span class="o">=</span> <span class="n">city_td</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//a&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">city_link</span> <span class="ow">in</span> <span class="n">city_links</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 城市</span>
</span></span><span class="line"><span class="cl">                <span class="n">city</span> <span class="o">=</span> <span class="n">city_link</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># get方法相当于取列表第0个元素.extract()</span>
</span></span><span class="line"><span class="cl">                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 城市的链接</span>
</span></span><span class="line"><span class="cl">                <span class="n">city_url</span> <span class="o">=</span> <span class="n">city_link</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//@href&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 以点分割城市的链接</span>
</span></span><span class="line"><span class="cl">                <span class="n">city_url_list</span> <span class="o">=</span> <span class="n">city_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 拼接城市二手房链接</span>
</span></span><span class="line"><span class="cl">                <span class="n">esfhouse_url</span> <span class="o">=</span> <span class="n">city_url_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.esf.&#39;</span> <span class="o">+</span> <span class="n">city_url_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">city_url_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;esfhouse_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">esfhouse_url</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 这里dict比较关键，因为我们只初始化了一次item = UrlItem()，对python底层实现不是很清楚，但如果不转化会重复append相同item对象。</span>
</span></span><span class="line"><span class="cl">                <span class="n">city_lis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">city_lis</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以这里return给谁了呢？与Scrapy框架图对应起来，return给了引擎，对应第7步，尝试在此直接输出到文件而**==不经过pipline==**。</p>
<h3 id="简单爬虫的持久化存储" class="headerLink">
    <a href="#%e7%ae%80%e5%8d%95%e7%88%ac%e8%99%ab%e7%9a%84%e6%8c%81%e4%b9%85%e5%8c%96%e5%ad%98%e5%82%a8" class="header-mark"></a>简单爬虫的持久化存储</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">scrapy crawl esf -o esf_url.json
</span></span></code></pre></td></tr></table>
</div>
</div><p>打开esf_url.json查看如下，json后缀默认中文为Unicode编码格式，csv和xml默认为utf-8编码格式</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[
</span></span><span class="line"><span class="cl">{&#34;province&#34;: &#34;\u5b89\u5fbd&#34;, &#34;city&#34;: &#34;\u5408\u80a5&#34;, &#34;esfhouse_url&#34;: &#34;http://hf.esf.fang.com/&#34;},
</span></span><span class="line"><span class="cl">{&#34;province&#34;: &#34;\u5b89\u5fbd&#34;, &#34;city&#34;: &#34;\u829c\u6e56&#34;, &#34;esfhouse_url&#34;: &#34;http://wuhu.esf.fang.com/&#34;},
</span></span><span class="line"><span class="cl">{&#34;province&#34;: &#34;\u5b89\u5fbd&#34;, &#34;city&#34;: &#34;\u6dee\u5357&#34;, &#34;esfhouse_url&#34;: &#34;http://huainan.esf.fang.com/&#34;},
</span></span><span class="line"><span class="cl">{&#34;province&#34;: &#34;\u5b89\u5fbd&#34;, &#34;city&#34;: &#34;\u868c\u57e0&#34;, &#34;esfhouse_url&#34;: &#34;http://bengbu.esf.fang.com/&#34;},
</span></span><span class="line"><span class="cl">{&#34;province&#34;: &#34;\u5b89\u5fbd&#34;, &#34;city&#34;: &#34;\u961c\u9633&#34;, &#34;esfhouse_url&#34;: &#34;http://fuyang.esf.fang.com/&#34;},
</span></span><span class="line"><span class="cl">……
</span></span><span class="line"><span class="cl">]
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">scrapy crawl esf -o esf_url.csv
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">city,esfhouse_url,province
</span></span><span class="line"><span class="cl">北京,http://bj.esf.fang.com/,直辖市
</span></span><span class="line"><span class="cl">上海,http://sh.esf.fang.com/,直辖市
</span></span><span class="line"><span class="cl">……
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">scrapy crawl esf -o esf_url.xml
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
</span></span><span class="line"><span class="cl">&lt;items&gt;
</span></span><span class="line"><span class="cl">&lt;item&gt;&lt;province&gt;直辖市&lt;/province&gt;&lt;city&gt;北京&lt;/city&gt;&lt;esfhouse_url&gt;http://bj.esf.fang.com/&lt;/esfhouse_url&gt;&lt;/item&gt;
</span></span><span class="line"><span class="cl">&lt;item&gt;&lt;province&gt;直辖市&lt;/province&gt;&lt;city&gt;上海&lt;/city&gt;&lt;esfhouse_url&gt;http://sh.esf.fang.com/&lt;/esfhouse_url&gt;&lt;/item&gt;
</span></span><span class="line"><span class="cl">……
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>老老实实存下来了，在此其实一个简单的爬虫就写好了，如果你只是要这个页面上的链接的话，已经完成了，然而这种写法难以进行写入数据库等存储操作，后续就要用到Pipline机制了。</p>
<h3 id="使用scrapy的pipline机制进行持久化存储" class="headerLink">
    <a href="#%e4%bd%bf%e7%94%a8scrapy%e7%9a%84pipline%e6%9c%ba%e5%88%b6%e8%bf%9b%e8%a1%8c%e6%8c%81%e4%b9%85%e5%8c%96%e5%ad%98%e5%82%a8" class="header-mark"></a>使用Scrapy的Pipline机制进行持久化存储。</h3><p>我们这里尝试使用yield方法返回item，改写爬虫类中的parse方法如下。（yield方法的使用与return显式区别是yield不会终止本程序运行，如果函数里有yield，且它在循环里，下次调用函数的时候，会直接从循环的下一次开始，而不是像return一样从函数从头到尾执行。更为详细的区别参考CSDN上的这篇<a href="https://blog.csdn.net/mieleizhi0522/article/details/82142856" target="_blank" rel="noopener noreffer">博客</a>）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">item</span> <span class="o">=</span> <span class="n">UrlItem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取数据的每一行tr，可能一行爲一個省份，也可能多行爲一個省份</span>
</span></span><span class="line"><span class="cl">    <span class="n">trs</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//*[@id=&#39;senfe&#39;]//tr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># print(trs)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">trs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取省份的td</span>
</span></span><span class="line"><span class="cl">        <span class="n">tds</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//td[not(@class)]&#34;</span><span class="p">)</span>  <span class="c1"># &#34;not(@class)&#34; ：没有为class赋值的被选取</span>
</span></span><span class="line"><span class="cl">        <span class="n">province_td</span> <span class="o">=</span> <span class="n">tds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># #获取省份的值</span>
</span></span><span class="line"><span class="cl">        <span class="n">province_text</span> <span class="o">=</span> <span class="n">province_td</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># #给省份去掉 多余空格</span>
</span></span><span class="line"><span class="cl">        <span class="n">province_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">province_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 判断省份是否为空的</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">province_text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 将不为空的省份赋值给province</span>
</span></span><span class="line"><span class="cl">            <span class="n">province</span> <span class="o">=</span> <span class="n">province_text</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 除去国外的链接</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">province</span> <span class="o">==</span> <span class="s1">&#39;其它&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 除去直辖市中的重庆和天津，因为在文中有写到</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">province</span> <span class="o">==</span> <span class="s1">&#39;重庆&#39;</span> <span class="ow">or</span> <span class="n">province</span> <span class="o">==</span> <span class="s1">&#39;天津&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;province&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">province</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取城市的td</span>
</span></span><span class="line"><span class="cl">        <span class="n">city_td</span> <span class="o">=</span> <span class="n">tds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取到城市的a元素</span>
</span></span><span class="line"><span class="cl">        <span class="n">city_links</span> <span class="o">=</span> <span class="n">city_td</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//a&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">city_link</span> <span class="ow">in</span> <span class="n">city_links</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 城市</span>
</span></span><span class="line"><span class="cl">            <span class="n">city</span> <span class="o">=</span> <span class="n">city_link</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># get方法相当于取列表第0个元素.extract()</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 城市的链接</span>
</span></span><span class="line"><span class="cl">            <span class="n">city_url</span> <span class="o">=</span> <span class="n">city_link</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//@href&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 以点分割城市的链接</span>
</span></span><span class="line"><span class="cl">            <span class="n">city_url_list</span> <span class="o">=</span> <span class="n">city_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 拼接城市二手房链接</span>
</span></span><span class="line"><span class="cl">            <span class="n">esfhouse_url</span> <span class="o">=</span> <span class="n">city_url_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.esf.&#39;</span> <span class="o">+</span> <span class="n">city_url_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">city_url_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;esfhouse_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">esfhouse_url</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 返回提取到的每个item给pipline，处理完成之后继续执行后面代码（下一个循环）</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="n">item</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>写pipline类，向piplines.py里写入如下内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scrapy.exporters</span> <span class="kn">import</span> <span class="n">CsvItemExporter</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ScrapyFangPipeline</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">url_fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;esf_url.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">url_exporter</span> <span class="o">=</span> <span class="n">CsvItemExporter</span><span class="p">(</span><span class="n">url_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">url_exporter</span><span class="o">.</span><span class="n">export_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 返回item对象是必须的，告诉引擎item已经处理完成了，可以继续执行后面代码。</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">close_spider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">url_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>启用pipline，在settings.py中写入如下，300为优先级，多个管道程序(执行类中的process_item方法)按照优先级依次进行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ITEM_PIPELINES</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;scrapy_fang.pipelines.ScrapyFangPipeline&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">scrapy crawl esf
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看生成的esf_url.csv如下</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">city,esfhouse_url,province
</span></span><span class="line"><span class="cl">北京,http://bj.esf.fang.com/,直辖市
</span></span><span class="line"><span class="cl">上海,http://sh.esf.fang.com/,直辖市
</span></span><span class="line"><span class="cl">天津,http://tj.esf.fang.com/,直辖市
</span></span><span class="line"><span class="cl">重庆,http://cq.esf.fang.com/,直辖市
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h3 id="至此完成基本的scrapy项目" class="headerLink">
    <a href="#%e8%87%b3%e6%ad%a4%e5%ae%8c%e6%88%90%e5%9f%ba%e6%9c%ac%e7%9a%84scrapy%e9%a1%b9%e7%9b%ae" class="header-mark"></a>至此完成基本的Scrapy项目</h3><p>基本Scrapy框架实现完成了单个页面上的数据爬取，省份，城市，链接……</p>
<h2 id="特定城市二手房概要信息爬虫" class="headerLink">
    <a href="#%e7%89%b9%e5%ae%9a%e5%9f%8e%e5%b8%82%e4%ba%8c%e6%89%8b%e6%88%bf%e6%a6%82%e8%a6%81%e4%bf%a1%e6%81%af%e7%88%ac%e8%99%ab" class="header-mark"></a>特定城市二手房概要信息爬虫</h2><p>我们在本次尝试直接拼接页码得到url，观察得到，北京二手房首页URL为http://bj.esf.fang.com/，也可以在页码中写为https://bj.esf.fang.com/house/i31/，第二页就是https://bj.esf.fang.com/house/i32/，依次类推……</p>
<p><img
        class="lazyload"
        data-src="MD_img/image-20220505170148978.png"
        data-srcset="/scrapy/MD_img/image-20220505170148978.png, MD_img/image-20220505170148978.png 1.5x, /scrapy/MD_img/image-20220505170148978.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/image-20220505170148978.png"
        title="image-20220505170148978"></p>
<p>在shell里面尝试能否抓到数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">scrapy shell https://bj.esf.fang.com/house/i31/
</span></span><span class="line"><span class="cl">&gt;&gt;&gt;response.xpath<span class="o">(</span><span class="s2">&#34;//dl[@dataflag=&#39;bg&#39;]&#34;</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>[]</p>
</blockquote>
<p>抓取失败（返回空），后面分析是URL重定向的原因，网站做了防护，让网页重定向去往了另一个URL。同时，测试发现http://bj.esf.fang.com/不会进行重定向操作，而想要访问迭代的网址https://bj.esf.fang.com/house/i31/，32，33等却会进行重定向。</p>
<h3 id="矛与盾重定向" class="headerLink">
    <a href="#%e7%9f%9b%e4%b8%8e%e7%9b%be%e9%87%8d%e5%ae%9a%e5%90%91" class="header-mark"></a>矛与盾——重定向</h3><p>分析返回的response</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;a class=&#34;btn-redir&#34; style=&#34;font-size: 14pt;&#34; href=&#34;https://bj.esf.fang.com/house/i31/?rfss=1-a9078821a1b90b2a70-34&#34;&gt;\xe7\x82\xb9\xe5\x87\xbb\xe8\xb7\xb3\xe8\xbd\xac&lt;/a&gt;\r\n&lt;/div&gt;\r\n&lt;/div&gt;\r\n&lt;script&gt;\r\n(function(){\r\n  var secs=100,si=setInterval(function(){\r\n    if(!--secs){\r\n      //location.href=&#34;https://bj.esf.fang.com/house/i31/?rfss=1-a9078821a1b90b2a70-34&#34;;\r\n      clearInterval(si);\r\n    }else{\r\n      jQuery(\&#39;.second\&#39;).text(secs);\r\n    }\r\n  }, 100)})();\r\n&lt;/script&gt;\r\n&lt;/div&gt;\r\n&lt;/div&gt;\r\n\r\n&lt;script&gt;\r\n/* $(&#34;.guan-intro&#34;).mouseover(function(){\r\n\t$(this).parents(&#34;.guan-wrap&#34;).siblings().show();\r\n}).mouseleave(function(){\r\n\t$(this).parents(&#34;.guan-wrap&#34;).siblings().hide();\r\n}); */\r\n\r\nfunction showDiv(size,obj){\r\n\tif(size&gt;32){\r\n\t\t$(obj).parents(&#34;.guan-wrap&#34;).siblings().show();\r\n\t}\r\n}\r\nfunction hideDiv(size,obj){\r\n\tif(size&gt;32){\r\n\t\t$(obj).parents(&#34;.guan-wrap&#34;).siblings().hide();\r\n\t}\r\n}\r\n&lt;/script&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;&#39;
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>可以看到，访问https://bj.esf.fang.com/house/i31/时网页重定向去了&quot;https://bj.esf.fang.com/house/i31/?rfss=1-a9078821a1b90b2a70-34&quot;这个网址，我们尝试获取这个网址的response。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">scrapy shell https://bj.esf.fang.com/house/i31/?rfss<span class="o">=</span>1-a9078821a1b90b2a70-34
</span></span><span class="line"><span class="cl">&gt;&gt;&gt;response.xpath<span class="o">(</span><span class="s2">&#34;//dl[@dataflag=&#39;bg&#39;]&#34;</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[&lt;Selector xpath=&#34;//dl[@dataflag=&#39;bg&#39;]&#34; data=&#39;&lt;dl class=&#34;clearfix&#34; dataflag=&#34;bg&#34; da...&#39;&gt;, &lt;Selector xpath=&#34;//dl[@dataflag=&#39;bg&#39;]&#34; data=&#39;&lt;dl class=&#34;clearfix&#34; dataflag=&#34;bg&#34; da...&#39;&gt;, &lt;Selector xpath=&#34;//dl[@dataflag=&#39;bg&#39;]&#34; data=&#39;&lt;dl class=&#34;clearfix&#34; dataflag=&#34;bg&#34; da...&#39;&gt;, &lt;Selector xpath=&#34;//dl[@dataflag=&#39;bg&#39;]&#34; data=&#39;&lt;dl class=&#34;clearfix&#34; dataflag=&#34;bg&#34; da...&#39;&gt;, &lt;Selector ……]
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>抓取成功了，后续将想法在中间件中实现。</p>
<h3 id="itempy" class="headerLink">
    <a href="#itempy" class="header-mark"></a>Item.py</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#二手房页面的Item</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EsfItem</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 省份</span>
</span></span><span class="line"><span class="cl">      <span class="n">province</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 城市</span>
</span></span><span class="line"><span class="cl">      <span class="n">city</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#二手房的标题</span>
</span></span><span class="line"><span class="cl">      <span class="n">title</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 二手房详细信息的链接</span>
</span></span><span class="line"><span class="cl">      <span class="n">esfhousenews_url</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 户型</span>
</span></span><span class="line"><span class="cl">      <span class="n">room_type</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 面积</span>
</span></span><span class="line"><span class="cl">      <span class="n">area</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 楼层</span>
</span></span><span class="line"><span class="cl">      <span class="n">floor</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 朝向</span>
</span></span><span class="line"><span class="cl">      <span class="n">orientation</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 建筑时间</span>
</span></span><span class="line"><span class="cl">      <span class="n">build_year</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 小区名字</span>
</span></span><span class="line"><span class="cl">      <span class="n">village_name</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 地址</span>
</span></span><span class="line"><span class="cl">      <span class="n">address</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 总价</span>
</span></span><span class="line"><span class="cl">      <span class="n">total</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#每平米的价格</span>
</span></span><span class="line"><span class="cl">      <span class="n">unit</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="esfpy" class="headerLink">
    <a href="#esfpy" class="header-mark"></a>esf.py</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">scrapy</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scrapy_fang.items</span> <span class="kn">import</span> <span class="n">UrlItem</span><span class="p">,</span> <span class="n">EsfItem</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EsfSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 别名，后续用来其启动爬虫</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;esf&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 允许爬取的页面</span>
</span></span><span class="line"><span class="cl">    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fang.com&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 启动爬取的页面</span>
</span></span><span class="line"><span class="cl">    <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;https://bj.esf.fang.com/house/i3</span><span class="si">%d</span><span class="s1">/&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;https://bj.esf.fang.com&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 总页数，解析赋值</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_num</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">get_page_num_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Scrapy框架默认调用这个方法。response.body是html源码</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 初次执行会进入，后续不进入</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_page_num_flag</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 获取总页码</span>
</span></span><span class="line"><span class="cl">            <span class="n">page_num_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//div[@class=&#39;page_al&#39;]/span/text()&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 将不是数字的替换为空</span>
</span></span><span class="line"><span class="cl">            <span class="n">page_num</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\D&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">page_num_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">page_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">page_num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">page_num</span> <span class="o">=</span> <span class="n">page_num</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">get_page_num_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;-------------------------------------------------对于二手房页面的解析--------------------------------------------------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">dls</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//dl[@class=&#39;clearfix&#39;]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">dls</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span> <span class="o">=</span> <span class="n">EsfItem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;province&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;直辖市&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;北京&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;build_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 二手房标题</span>
</span></span><span class="line"><span class="cl">            <span class="n">title</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//h4[@class=&#39;clearfix&#39;]/a/@title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 二手房详情链接</span>
</span></span><span class="line"><span class="cl">            <span class="n">esfhousenews_url_text</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//h4[@class=&#39;clearfix&#39;]/a/@href&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">esfhousenews_url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">esfhousenews_url_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># print(esfhousenews_url)</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;esfhousenews_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">esfhousenews_url</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 二手房信息</span>
</span></span><span class="line"><span class="cl">            <span class="n">lists</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//p[@class=&#39;tel_shop&#39;]/text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">getall</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="nb">list</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s1">&#39;室&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 户型</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;room_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="s1">&#39;㎡&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 面积</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="s1">&#39;层&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 楼层</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;floor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="s1">&#39;向&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 朝向</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="s1">&#39;年&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 建筑时间</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;build_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 小区名字</span>
</span></span><span class="line"><span class="cl">            <span class="n">village_name</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//p[@class=&#39;add_shop&#39;]/a/@title&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;village_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">village_name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 地址</span>
</span></span><span class="line"><span class="cl">            <span class="n">address</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//p[@class=&#39;add_shop&#39;]/span/text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 总价</span>
</span></span><span class="line"><span class="cl">            <span class="n">total_price</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//dd[@class=&#39;price_right&#39;]/span[@class=&#39;red&#39;]/b/text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_price</span>
</span></span><span class="line"><span class="cl">            <span class="n">unit_price</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//dd[@class=&#39;price_right&#39;]/span[not(@class)]/text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 每平方米的价格</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_price</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 下一页的链接</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_num</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">next_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 跳到下一页</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">next_link</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="middlewarespy" class="headerLink">
    <a href="#middlewarespy" class="header-mark"></a>middlewares.py</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scrapy.http</span> <span class="kn">import</span> <span class="n">HtmlResponse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 模拟浏览器请求头</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserAgentDownloadMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">User_Agents</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (X11; Linux i686; rv:64.0) Gecko/20100101 Firefox/64.0&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.13; ko; rv:1.9.1b2) Gecko/2008&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;1201 Firefox/60.0&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39; Chrome/70.0.3538.77 Safari/537.36&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML like Gecko) Chrome&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;/44.0.2403.155 Safari/537.36&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 随机请求头</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">User_Agent</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">User_Agents</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">User_Agent</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 处理URL重定向问题</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ProcessRedirectionMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">User_Agents</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (X11; Linux i686; rv:64.0) Gecko/20100101 Firefox/64.0&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.13; ko; rv:1.9.1b2) Gecko/2008&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;1201 Firefox/60.0&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39; Chrome/70.0.3538.77 Safari/537.36&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML like Gecko) Chrome&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;/44.0.2403.155 Safari/537.36&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">User_Agent</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">User_Agents</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 从response的body中提取重定向的网址</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">redirected_url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//a[@class=&#39;btn-redir&#39;]//@href&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果抓取成功，则说明进行了重定向，返回目标网址的response</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">redirected_url</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redirected_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User_Agent&#39;</span><span class="p">:</span> <span class="n">User_Agent</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 构造scrapy的response对象。</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">HtmlResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">redirected_url</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 否则返回原response</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="settingspy" class="headerLink">
    <a href="#settingspy" class="header-mark"></a>settings.py</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 下载器中间件，添加请求头，处理重定向</span>
</span></span><span class="line"><span class="cl"><span class="n">DOWNLOADER_MIDDLEWARES</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;scrapy_fang.middlewares.UserAgentDownloadMiddleware&#39;</span><span class="p">:</span> <span class="mi">543</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;scrapy_fang.middlewares.ProcessRedirectionMiddleware&#39;</span><span class="p">:</span> <span class="mi">553</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 指定Pipline，本流程用于保存yield的item数据</span>
</span></span><span class="line"><span class="cl"><span class="n">ITEM_PIPELINES</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;scrapy_fang.pipelines.ScrapyFangPipeline&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 允许爬虫缓存（不会重复请求目标页面，一次请求成功后，会存在缓存中，减小网站压力。）</span>
</span></span><span class="line"><span class="cl"><span class="n">HTTPCACHE_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="n">HTTPCACHE_EXPIRATION_SECS</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">HTTPCACHE_DIR</span> <span class="o">=</span> <span class="s1">&#39;httpcache&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">HTTPCACHE_IGNORE_HTTP_CODES</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">HTTPCACHE_STORAGE</span> <span class="o">=</span> <span class="s1">&#39;scrapy.extensions.httpcache.FilesystemCacheStorage&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 是否遵循robots协议</span>
</span></span><span class="line"><span class="cl"><span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Configure maximum concurrent requests performed by Scrapy (default: 16)</span>
</span></span><span class="line"><span class="cl"><span class="n">CONCURRENT_REQUESTS</span> <span class="o">=</span> <span class="mi">32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 延时最低为0</span>
</span></span><span class="line"><span class="cl"><span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="pipelinespy" class="headerLink">
    <a href="#pipelinespy" class="header-mark"></a>pipelines.py</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scrapy.exporters</span> <span class="kn">import</span> <span class="n">CsvItemExporter</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ScrapyFangPipeline</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">esf_info_fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;esf_info.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">esf_info_exporter</span> <span class="o">=</span> <span class="n">CsvItemExporter</span><span class="p">(</span><span class="n">esf_info_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">esf_info_exporter</span><span class="o">.</span><span class="n">export_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 返回是必须的，告诉引擎item已经处理完成了，可以继续执行后面代码。</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">close_spider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">esf_info_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="启动爬虫" class="headerLink">
    <a href="#%e5%90%af%e5%8a%a8%e7%88%ac%e8%99%ab" class="header-mark"></a>启动爬虫</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">scrapy crawl esf
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="获得爬得数据" class="headerLink">
    <a href="#%e8%8e%b7%e5%be%97%e7%88%ac%e5%be%97%e6%95%b0%e6%8d%ae" class="header-mark"></a>获得爬得数据</h3><p><img
        class="lazyload"
        data-src="MD_img/image-20220506104545674.png"
        data-srcset="/scrapy/MD_img/image-20220506104545674.png, MD_img/image-20220506104545674.png 1.5x, /scrapy/MD_img/image-20220506104545674.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/image-20220506104545674.png"
        title="image-20220506104545674"></p>
<h2 id="多城市二手房详情页爬虫" class="headerLink">
    <a href="#%e5%a4%9a%e5%9f%8e%e5%b8%82%e4%ba%8c%e6%89%8b%e6%88%bf%e8%af%a6%e6%83%85%e9%a1%b5%e7%88%ac%e8%99%ab" class="header-mark"></a>多城市二手房详情页爬虫</h2><h3 id="完整爬取流程" class="headerLink">
    <a href="#%e5%ae%8c%e6%95%b4%e7%88%ac%e5%8f%96%e6%b5%81%e7%a8%8b" class="header-mark"></a>完整爬取流程</h3><center>从城市页拿到各城市二手房链接页的基础URL</center>
<p><img
        class="lazyload"
        data-src="MD_img/image-20220517091511727.png"
        data-srcset="/scrapy/MD_img/image-20220517091511727.png, MD_img/image-20220517091511727.png 1.5x, /scrapy/MD_img/image-20220517091511727.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/image-20220517091511727.png"
        title="image-20220517091511727"></p>
<p><img
        class="lazyload"
        data-src="MD_img/image-20220517091617896.png"
        data-srcset="/scrapy/MD_img/image-20220517091617896.png, MD_img/image-20220517091617896.png 1.5x, /scrapy/MD_img/image-20220517091617896.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/image-20220517091617896.png"
        title="image-20220517091617896"></p>
<center>进入列表页拿到基本信息以及指向详情页的URL</center>
<p><img
        class="lazyload"
        data-src="MD_img/image-20220517092051387.png"
        data-srcset="/scrapy/MD_img/image-20220517092051387.png, MD_img/image-20220517092051387.png 1.5x, /scrapy/MD_img/image-20220517092051387.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/image-20220517092051387.png"
        title="image-20220517092051387"></p>
<p><img
        class="lazyload"
        data-src="MD_img/image-20220517091617896.png"
        data-srcset="/scrapy/MD_img/image-20220517091617896.png, MD_img/image-20220517091617896.png 1.5x, /scrapy/MD_img/image-20220517091617896.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/image-20220517091617896.png"
        title="image-20220517091617896"></p>
<center>从详情页获取有关二手房的详情信息</center>
<p><img
        class="lazyload"
        data-src="MD_img/image-20220517092606171.png"
        data-srcset="/scrapy/MD_img/image-20220517092606171.png, MD_img/image-20220517092606171.png 1.5x, /scrapy/MD_img/image-20220517092606171.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/image-20220517092606171.png"
        title="image-20220517092606171"></p>
<p><img
        class="lazyload"
        data-src="MD_img/image-20220517092635138.png"
        data-srcset="/scrapy/MD_img/image-20220517092635138.png, MD_img/image-20220517092635138.png 1.5x, /scrapy/MD_img/image-20220517092635138.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/image-20220517092635138.png"
        title="image-20220517092635138"></p>
<p><img
        class="lazyload"
        data-src="MD_img/image-20220517092712483.png"
        data-srcset="/scrapy/MD_img/image-20220517092712483.png, MD_img/image-20220517092712483.png 1.5x, /scrapy/MD_img/image-20220517092712483.png 2x"
        data-sizes="auto"
        alt="/scrapy/MD_img/image-20220517092712483.png"
        title="image-20220517092712483"></p>
<h3 id="矛与盾" class="headerLink">
    <a href="#%e7%9f%9b%e4%b8%8e%e7%9b%be" class="header-mark"></a>矛与盾</h3><p>由于网站的防护，房天下网站有一系列反爬机制，有些隐藏的很深，也是通过实践才发现的。本节主要介绍作者对于反爬验证的主要解决方法，robot协议，延时爬取这种就不在这里展开详细阐述了。</p>
<h4 id="ip代理" class="headerLink">
    <a href="#ip%e4%bb%a3%e7%90%86" class="header-mark"></a>IP代理</h4><p>IP代理是爬虫的一个关键技术，通常情况下，网站会通过同一个IP地址的并发请求量来判断这是否为一个爬虫，因此，IP代理便可以使用其他代理IP进行请求的转发，来隐藏发出请求的原始IP，以达到持续爬取而不被检测到的目的。接下来介绍尝试过的两种IP代理方法。</p>
<ul>
<li>
<p><strong>IP代理池方法</strong></p>
<p>简述：通过向代理商获取一定数量的IP作为代理池，每次请求使用代理池其中的一个IP进行转发。在请求时进行代理，创建IP代理中间件方法如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ProxyDownloaderMiddleware</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxy</span> <span class="o">=</span> <span class="n">pro</span><span class="o">.</span><span class="n">get_next_proxy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;http://</span><span class="si">%(proxy)s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;proxy&#39;</span><span class="p">:</span> <span class="n">proxy</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;*****************使用代理*****************&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;***&#34;</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="s2">&#34;***&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;*****************************************&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 用户名密码认证(私密代理/独享代理)</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Proxy-Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_auth_header</span><span class="p">(</span><span class="s1">&#39;a15179737600&#39;</span><span class="p">,</span> <span class="s1">&#39;p8x7284f&#39;</span><span class="p">)</span>  <span class="c1"># 白名单认证可注释此行</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>获取IP代理池程序（每过60s获取一次），从服务商获取到可用的IP列表之后，我们也可以自行进行可用性检测，以免所使用的代理IP无效。本人采用的方法是使用代理IP访问http://icanhazip.com，此网站会返回当前的IP地址，如果状态码为200表明成功访问，于是成功加入代理池。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># -- coding: utf-8 --</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scrapy</span> <span class="kn">import</span> <span class="n">signals</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 提取代理IP的api</span>
</span></span><span class="line"><span class="cl"><span class="n">api_url</span> <span class="o">=</span> <span class="s1">&#39;https://dps.kdlapi.com/api/getdps/?orderid=965208072230596&amp;num=10&amp;signature=bqcsohuyc0qcmz1446bn3jt234sbcezq&amp;pt=1&amp;format=json&amp;sep=1&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">foo</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Proxy</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">api_url</span> <span class="o">=</span> <span class="n">api_url</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;a15179737600&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;p8x7284f&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_proxy_lis</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_proxy_lis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;-------------------------------------------------从代理商获取IP代理池--------------------------------------------------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxy_lis</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;proxy_list&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;-------------------------------------------------获取成功，开始测试IP代理池--------------------------------------------------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 测试连通性</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxy_lis</span> <span class="o">=</span> <span class="p">[</span><span class="n">proxy</span> <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxy_lis</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verification</span><span class="p">(</span><span class="n">proxy</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 可用代理列表长度为零则重新获取</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_lis</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;-------------------------------------------------可用IP代理获取失败，重新获取中------------</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">                --------------------------------------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">proxy_lis</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;proxy_list&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;-------------------------------------------------开始测试新获IP代理池--------------------------------------------------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 测试连通性</span>
</span></span><span class="line"><span class="cl">            <span class="n">proxy_lis</span> <span class="o">=</span> <span class="p">[</span><span class="n">proxy</span> <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxy_lis</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verification</span><span class="p">(</span><span class="n">proxy</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;-------------------------------------------------成功获得可用IP代理池（大小为</span><span class="si">%d</span><span class="s2">）如下--------------------------------------------------&#34;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_lis</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">proxy_lis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">index_</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">proxy_lis</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_next_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">index_</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index_</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_list</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">proxy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">proxy_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_list</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@proxy_list</span><span class="o">.</span><span class="n">setter</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">proxy_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_list</span> <span class="o">=</span> <span class="nb">list</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 测试IP代理是否正常响应</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">head</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Connection&#39;</span><span class="p">:</span> <span class="s1">&#39;keep-alive&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#39;&#39;http://icanhazip.com会返回当前的IP地址&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;http&#34;</span><span class="p">:</span> <span class="s2">&#34;http://</span><span class="si">%(user)s</span><span class="s2">:</span><span class="si">%(pwd)s</span><span class="s2">@</span><span class="si">%(proxy)s</span><span class="s2">/&#34;</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&#34;user&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&#34;pwd&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="s2">&#34;proxy&#34;</span><span class="p">:</span> <span class="n">proxy</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;https&#34;</span><span class="p">:</span> <span class="s2">&#34;http://</span><span class="si">%(user)s</span><span class="s2">:</span><span class="si">%(pwd)s</span><span class="s2">@</span><span class="si">%(proxy)s</span><span class="s2">/&#34;</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&#34;user&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&#34;pwd&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="s2">&#34;proxy&#34;</span><span class="p">:</span> <span class="n">proxy</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://icanhazip.com&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">head</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pro</span> <span class="o">=</span> <span class="n">Proxy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">proxy_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyExtend</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crawler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">crawler</span> <span class="o">=</span> <span class="n">crawler</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 将自定义方法绑定到scrapy信号上,使程序与spider引擎同步启动与关闭</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># scrapy信号文档: https://www.osgeo.cn/scrapy/topics/signals.html</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># scrapy自定义拓展文档: https://www.osgeo.cn/scrapy/topics/extensions.html</span>
</span></span><span class="line"><span class="cl">        <span class="n">crawler</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">signals</span><span class="o">.</span><span class="n">engine_started</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">crawler</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">signals</span><span class="o">.</span><span class="n">spider_closed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@classmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">from_crawler</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">crawler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">crawler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_proxy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">extract_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">foo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置每60秒提取一次ip</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pro</span><span class="o">.</span><span class="n">proxy_list</span> <span class="o">=</span> <span class="n">pro</span><span class="o">.</span><span class="n">get_proxy_lis</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">global</span> <span class="n">foo</span>
</span></span><span class="line"><span class="cl">        <span class="n">foo</span> <span class="o">=</span> <span class="kc">False</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>TUN隧道IP代理方法</strong></p>
<p>隧道代理是通过代理商的链接直接获取一个代理IP，可以选择每次访问切换以及每几分钟切换IP等，使用较为便捷，以下是中间件的代理方法实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 隧道代理</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TUNProxyDownloaderMiddleware</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxy</span> <span class="o">=</span> <span class="s2">&#34;tps553.kdlapi.com:15818&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;http://</span><span class="si">%(proxy)s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;proxy&#39;</span><span class="p">:</span> <span class="n">proxy</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 用户名密码认证</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Proxy-Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_auth_header</span><span class="p">(</span><span class="s1">&#39;t15209935663171&#39;</span><span class="p">,</span> <span class="s1">&#39;obs96q91&#39;</span><span class="p">)</span>  <span class="c1"># 白名单认证可注释此行</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Connection&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;close&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在隧道代理的使用中，可以重写Retry方法（代理池操作类似），在目标页面访问失败时，更换代理IP，减小由于代理IP失效带来的影响，使得爬取的成功率更高。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># TUN模式更换代理</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">My_RetryMiddleware</span><span class="p">(</span><span class="n">RetryMiddleware</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">get_head</span> <span class="o">=</span> <span class="n">GetRandomUserAgent</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXCEPTIONS_TO_RETRY</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">proxy</span> <span class="o">=</span> <span class="s2">&#34;tps553.kdlapi.com:15818&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">request</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;http://</span><span class="si">%(proxy)s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;proxy&#39;</span><span class="p">:</span> <span class="n">proxy</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 用户名密码认证</span>
</span></span><span class="line"><span class="cl">            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Proxy-Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_auth_header</span><span class="p">(</span><span class="s1">&#39;t15209935663171&#39;</span><span class="p">,</span> <span class="s1">&#39;obs96q91&#39;</span><span class="p">)</span>  <span class="c1"># 白名单认证可注释此行</span>
</span></span><span class="line"><span class="cl">            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Connection&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;close&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">UserAgent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_head</span><span class="o">.</span><span class="n">agent_head</span><span class="p">()[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&#34;User-Agent&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UserAgent</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;出现异常</span><span class="si">%s</span><span class="s2">，触发自定义重试中间件，更换ip代理&#34;</span> <span class="o">%</span> <span class="n">exception</span><span class="p">,</span> <span class="s2">&#34;*&#34;</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="selenium模拟拖动绕过验证码" class="headerLink">
    <a href="#selenium%e6%a8%a1%e6%8b%9f%e6%8b%96%e5%8a%a8%e7%bb%95%e8%bf%87%e9%aa%8c%e8%af%81%e7%a0%81" class="header-mark"></a>selenium模拟拖动，绕过验证码</h4><p>在访问量大的时候，难免遇到验证码的情况，房天下久经沙场，已经拥有了很强的反爬机制。</p>
<p>在遇到验证码的时候，不妨使用Selenium来模拟浏览器操作，然后对通过后的页面进行解析，详细验证操作如下。</p>
<p>使用时间戳命名来保存拖动的背景图片和目标图片，并用opencv来识别边界，获取准确的像素坐标，使用driver模拟拖动动作，来完成验证码绕过。(如果需要高匿性质服务，建议挂上代理，由于要下载图片以及模拟网页操作，建议上稳定延迟的爬虫，最好带宽也大些，本次项目就直接用本地网络解了，未挂代理，因为我能保证本地是稳定的，当然，你也可以自己测开放代理池择优拿来用。)</p>
<p>在拖动的时候，为防止人机识别，模拟人拖动的操作，利用加速度公式，得到每次进行拖动的距离，分段拖动，并加入停顿设置，使得验证过程更为拟人化，提高验证的通过率。关键实现如下，通过提前为拖动指针设置轨迹来完成。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">根据偏移量获取移动轨迹
</span></span></span><span class="line"><span class="cl"><span class="s2">:param distance: 偏移量
</span></span></span><span class="line"><span class="cl"><span class="s2">:return: 移动轨迹
</span></span></span><span class="line"><span class="cl"><span class="s2">相关公式：
</span></span></span><span class="line"><span class="cl"><span class="s2">x = x0 * t + 0.5 * a * t * t
</span></span></span><span class="line"><span class="cl"><span class="s2">v = v0 + a * t
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 初速度</span>
</span></span><span class="line"><span class="cl"><span class="n">t</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 单位时间为0.2s来统计轨迹，轨迹即0.2内的位移</span>
</span></span><span class="line"><span class="cl"><span class="n">tracks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 位移/轨迹列表，列表内的一个元素代表0.2s的位移</span>
</span></span><span class="line"><span class="cl"><span class="n">current</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 当前的位移</span>
</span></span><span class="line"><span class="cl"><span class="n">mid</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># 到达mid值开始减速</span>
</span></span><span class="line"><span class="cl"><span class="n">distance</span> <span class="o">+=</span> <span class="mi">20</span>  <span class="c1"># 先滑过一点，最后再反着滑动回来</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">mid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 加速度越小，单位时间的位移越小,模拟的轨迹就越多越详细</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># 加速运动</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>  <span class="c1"># 减速运动</span>
</span></span><span class="line"><span class="cl">    <span class="n">v0</span> <span class="o">=</span> <span class="n">v</span>  <span class="c1"># 初速度</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 0.2秒时间内的位移</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span> <span class="o">+=</span> <span class="n">s</span>  <span class="c1"># 当前的位置</span>
</span></span><span class="line"><span class="cl">    <span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>  <span class="c1"># 添加到轨迹列表</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 实现停顿</span>
</span></span><span class="line"><span class="cl">    <span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">v</span> <span class="o">=</span> <span class="mf">0.2</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># v = v0 + a * t  # 速度已经达到v,该速度作为下次的初速度</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 反着滑动到大概准确位置</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">tracks</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>同时，由于失败后的刷新机制，也可设置拖动次数，如果一个页面拖动不成功，我们就再试几次，因为可能遇到更好通过的图形，有助于成功验证。成功后，我们返回对HTML源码的解析得到的有关二手房详情页信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 隐式等待</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">verification_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;.info p&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">verification_code</span> <span class="o">==</span> <span class="s2">&#34;请拖动滑块进行验证：&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sucess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;.drag-text&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># print(sucess, &#39;*&#39;*200)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 下载验证码</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 识别次数大于3次换页</span>
</span></span><span class="line"><span class="cl">            <span class="n">locate_time</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="n">sucess</span> <span class="o">!=</span> <span class="s1">&#39;验证通过啦！&#39;</span> <span class="ow">and</span> <span class="n">locate_time</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">get_captcha</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_matching</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bg_jpg_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_png_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">move_to_gap</span><span class="p">([</span><span class="n">x</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sucess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;.drag-text&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1"># 定位次数+1</span>
</span></span><span class="line"><span class="cl">                <span class="n">locate_time</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;验证码循环1，-第</span><span class="si">%d</span><span class="s2">次&#34;</span> <span class="o">%</span> <span class="n">locate_time</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">sucess</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&#34;captcha_submit_btn&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">Html_document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="s2">&#34;return document.documentElement.outerHTML&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_target</span> <span class="o">==</span> <span class="s1">&#39;page_num&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_page_num</span><span class="p">(</span><span class="n">Html_document</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_target</span> <span class="o">==</span> <span class="s1">&#39;EsfItem&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># print(self.parse_lis_page(Html_document))</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_lis_page</span><span class="p">(</span><span class="n">Html_document</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_target</span> <span class="o">==</span> <span class="s1">&#39;EsfInfoItem&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># print(self.parse_info_page(Html_document))</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_info_page</span><span class="p">(</span><span class="n">Html_document</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 刷新页面得到新图</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;验证码处理超3次退出！&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;验证码处理异常！</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 尝试关闭driver</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="主要类定义" class="headerLink">
    <a href="#%e4%b8%bb%e8%a6%81%e7%b1%bb%e5%ae%9a%e4%b9%89" class="header-mark"></a>主要类定义</h3><h4 id="爬虫文件" class="headerLink">
    <a href="#%e7%88%ac%e8%99%ab%e6%96%87%e4%bb%b6" class="header-mark"></a>爬虫文件</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EsfSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 别名，后续用来其启动爬虫</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;esf&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 允许爬取的页面</span>
</span></span><span class="line"><span class="cl">    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fang.com&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 启动爬取的页面</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;https://www.fang.com/SoufunFamily.htm&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取随机请求头</span>
</span></span><span class="line"><span class="cl">    <span class="n">get_random_UserAgent</span> <span class="o">=</span> <span class="n">GetRandomUserAgent</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># 重定向链接获取方法</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_redirected_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_UserAgent</span><span class="o">.</span><span class="n">agent_head</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 构造scrapy的response对象。</span>
</span></span><span class="line"><span class="cl">        <span class="n">req_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">head</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">HtmlResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">req_response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 处理重定向</span>
</span></span><span class="line"><span class="cl">        <span class="n">redirected_url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//a[@class=&#39;btn-redir&#39;]//@href&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果抓取成功，则说明进行了重定向，发送一个新的请求而不是将得到的响应发给爬虫程序</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">redirected_url</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;重定向&#34;</span><span class="p">,</span> <span class="n">redirected_url</span><span class="p">,</span> <span class="s2">&#34;*&#34;</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">redirected_url</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">url</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Scrapy框架默认调用这个方法。response.body是html源码</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;esf_info.csv&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">esfhousenews_urls</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;esfhousenews_url&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">        <span class="n">provinces</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;province&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">        <span class="n">cities</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;city&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">esfhousenews_urls</span><span class="p">,</span> <span class="n">provinces</span><span class="p">,</span> <span class="n">cities</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">esfhousenews_url</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">province</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">city</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">directed_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_redirected_url</span><span class="p">(</span><span class="n">esfhousenews_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">directed_url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_esfhouseInfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;info&#34;</span><span class="p">:</span> <span class="p">(</span><span class="n">province</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="n">directed_url</span><span class="p">)},</span> <span class="n">dont_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;捕获异常</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">ex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 对于二手房详情页面的解析</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse_esfhouseInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">province</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="n">esf_link</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;info&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;-------------------------------------------------对于</span><span class="si">%s</span><span class="s2">二手房 </span><span class="si">%s</span><span class="s2"> 详情页的解析--------------------------------------------------&#34;</span> <span class="o">%</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">province</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">city</span><span class="p">,</span> <span class="n">esf_link</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 验证码</span>
</span></span><span class="line"><span class="cl">        <span class="n">response_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">house_info_divs</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;//div[contains(@class, &#39;tr-line clearfix&#39;)]//div[contains(@class,&#39;trl-item1&#39;)]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s1">&#39;captcha&#39;</span> <span class="ow">in</span> <span class="n">response_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">house_info_divs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;captcha.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_url</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;处理验证码&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">deal_captcha</span> <span class="o">=</span> <span class="n">DealCaptcha</span><span class="p">(</span><span class="n">parse_target</span><span class="o">=</span><span class="s1">&#39;EsfInfoItem&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">response_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span> <span class="o">=</span> <span class="n">deal_captcha</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;province&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">province</span>
</span></span><span class="line"><span class="cl">                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
</span></span><span class="line"><span class="cl">                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;esf_link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">esf_link</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">house_info_divs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;链接解析成功了&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span> <span class="o">=</span> <span class="n">EsfInfoItem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;province&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">province</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;esf_link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">esf_link</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">title</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//span[@class=&#39;tit_text&#39;]//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">house_info_divs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 户型</span>
</span></span><span class="line"><span class="cl">                <span class="n">room_type</span> <span class="o">=</span> <span class="n">house_info_divs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[@class=&#39;tt&#39;]//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">room_type</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;room_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">room_type</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 面积</span>
</span></span><span class="line"><span class="cl">                <span class="n">area</span> <span class="o">=</span> <span class="n">house_info_divs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[@class=&#39;tt&#39;]//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">area</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 单价</span>
</span></span><span class="line"><span class="cl">                <span class="n">unit_price</span> <span class="o">=</span> <span class="n">house_info_divs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[@class=&#39;tt&#39;]//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit_price</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_price</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 朝向</span>
</span></span><span class="line"><span class="cl">                <span class="n">orientation</span> <span class="o">=</span> <span class="n">house_info_divs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[@class=&#39;tt&#39;]//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">orientation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orientation</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 楼层</span>
</span></span><span class="line"><span class="cl">                <span class="n">floor_info</span> <span class="o">=</span> <span class="n">house_info_divs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[@class=&#39;tt&#39;]//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">floor_info_a</span> <span class="o">=</span> <span class="n">house_info_divs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[@class=&#39;tt&#39;]//a//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">floor_type</span> <span class="o">=</span> <span class="n">house_info_divs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[@class=&#39;font14&#39;]//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">floor_info_a</span> <span class="ow">and</span> <span class="n">floor_type</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;floor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">floor_info_a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">floor_type</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">floor_info</span> <span class="ow">and</span> <span class="n">floor_type</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;floor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">floor_info</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">floor_type</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 装修</span>
</span></span><span class="line"><span class="cl">                <span class="n">decoration</span> <span class="o">=</span> <span class="n">house_info_divs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[@class=&#39;tt&#39;]//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">decoration_a</span> <span class="o">=</span> <span class="n">house_info_divs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[@class=&#39;tt&#39;]/a//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">decoration_a</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;decoration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoration_a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">decoration</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;decoration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoration</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 总价</span>
</span></span><span class="line"><span class="cl">            <span class="n">total_price</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//div[contains(@class, &#39;price_esf&#39;)]/i//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">total_price</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;total_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_price</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;万元&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 房源信息</span>
</span></span><span class="line"><span class="cl">            <span class="n">xpath_house_info_lis</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;//div[contains(@class, &#39;content-item fydes-item&#39;)]//div[contains(@class, &#39;cont clearfix&#39;)]//div&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">div</span> <span class="ow">in</span> <span class="n">xpath_house_info_lis</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 建筑年代</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;建筑年代&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">build_year</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;build_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_year</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 小区</span>
</span></span><span class="line"><span class="cl">            <span class="n">community</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//a[@id=&#39;kesfsfbxq_A01_01_05&#39;]//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">community</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;community&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">community</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 小区信息</span>
</span></span><span class="line"><span class="cl">            <span class="n">xpath_community_info_lis</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//div[contains(@class, &#39;cont pt30&#39;)]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 小区信息顶栏</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">div</span> <span class="ow">in</span> <span class="n">xpath_community_info_lis</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[contains(@class, &#39;topt clearfix&#39;)]//div&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 小区参考均价</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;参考均价&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">community_price</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//i//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">community_price</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;community_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">community_price</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; 元/平米&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1"># 小区均价同比去年</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;同比去年&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">community_price_to_last_year</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//em//span//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">community_price_to_last_year</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;community_price_to_last_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">community_price_to_last_year</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 小区均价环比上月</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;环比上月&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">community_price_to_last_month</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//em//span//text()&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">community_price_to_last_month</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;community_price_to_last_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">community_price_to_last_month</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">div</span> <span class="ow">in</span> <span class="n">xpath_community_info_lis</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//div[@class=&#39;clearfix&#39;]//div&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span&#34;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 绿化率</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="s1">&#39;绿&#39;</span> <span class="ow">in</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="n">plant_rate</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">plant_rate</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;plant_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant_rate</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 小区容积率</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="s1">&#39;容&#39;</span> <span class="ow">in</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="n">community_volume_rate</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">community_volume_rate</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;community_volume_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">community_volume_rate</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 小区总户数</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="s1">&#39;户&#39;</span> <span class="ow">in</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="n">community_total_family_num</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">community_total_family_num</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;community_total_family_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">community_total_family_num</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 产权年限</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;产权年限&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">property_tenure</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">property_tenure</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;property_tenure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">property_tenure</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;年&#39;</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 小区总楼栋数</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;总楼栋数&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">community_total_building_num</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">community_total_building_num</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;community_total_building_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">community_total_building_num</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 小区物业费用</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;物业费用&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">community_property_expenses</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">community_property_expenses</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;community_property_expenses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">community_property_expenses</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 小区人车分流</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;人车分流&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">community_people_vehicles_depart</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;.//span//text()&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">community_people_vehicles_depart</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;community_people_vehicles_depart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">community_people_vehicles_depart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">item</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="管道文件" class="headerLink">
    <a href="#%e7%ae%a1%e9%81%93%e6%96%87%e4%bb%b6" class="header-mark"></a>管道文件</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ScrapyFangPipeline</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">open_spider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># # URL</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">url_fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;esf_url.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">url_exporter</span> <span class="o">=</span> <span class="n">CsvItemExporter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># # 二手房信息</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">esf_info_fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;esf_info.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">esf_info_exporter</span> <span class="o">=</span> <span class="n">CsvItemExporter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esf_info_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 二手房详情信息</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">esf_detail_info_fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;esf_detail_info.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">esf_detail_info_exporter</span> <span class="o">=</span> <span class="n">CsvItemExporter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esf_detail_info_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># # 处理URL</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">UrlItem</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;存放二手房链接信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">url_exporter</span><span class="o">.</span><span class="n">export_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># # 处理二手房信息</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EsfItem</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;存放二手房房源信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">esf_info_exporter</span><span class="o">.</span><span class="n">export_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 处理详情页信息</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EsfInfoItem</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;存放二手房房源详情信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">esf_detail_info_exporter</span><span class="o">.</span><span class="n">export_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 返回是必须的，告诉引擎item已经处理完成了，可以继续执行后面代码。</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">close_spider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">esf_info_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">url_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">esf_detail_info_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="item文件" class="headerLink">
    <a href="#item%e6%96%87%e4%bb%b6" class="header-mark"></a>Item文件</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UrlItem</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 省份</span>
</span></span><span class="line"><span class="cl">    <span class="n">province</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 城市</span>
</span></span><span class="line"><span class="cl">    <span class="n">city</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 二手房链接</span>
</span></span><span class="line"><span class="cl">    <span class="n">esfhouse_url</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#二手房页面的Item</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EsfItem</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 省份</span>
</span></span><span class="line"><span class="cl">      <span class="n">province</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 城市</span>
</span></span><span class="line"><span class="cl">      <span class="n">city</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#二手房的标题</span>
</span></span><span class="line"><span class="cl">      <span class="n">title</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 二手房详细信息的链接</span>
</span></span><span class="line"><span class="cl">      <span class="n">esfhousenews_url</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 户型</span>
</span></span><span class="line"><span class="cl">      <span class="n">room_type</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 面积</span>
</span></span><span class="line"><span class="cl">      <span class="n">area</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 楼层</span>
</span></span><span class="line"><span class="cl">      <span class="n">floor</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 朝向</span>
</span></span><span class="line"><span class="cl">      <span class="n">orientation</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 建筑时间</span>
</span></span><span class="line"><span class="cl">      <span class="n">build_year</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 小区名字</span>
</span></span><span class="line"><span class="cl">      <span class="n">village_name</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 地址</span>
</span></span><span class="line"><span class="cl">      <span class="n">address</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 总价</span>
</span></span><span class="line"><span class="cl">      <span class="n">total</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#每平米的价格</span>
</span></span><span class="line"><span class="cl">      <span class="n">unit</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EsfInfoItem</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 详情页链接</span>
</span></span><span class="line"><span class="cl">    <span class="n">esf_link</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 省份</span>
</span></span><span class="line"><span class="cl">    <span class="n">province</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 城市</span>
</span></span><span class="line"><span class="cl">    <span class="n">city</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 二手房的标题</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 户型</span>
</span></span><span class="line"><span class="cl">    <span class="n">room_type</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 面积</span>
</span></span><span class="line"><span class="cl">    <span class="n">area</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 单价</span>
</span></span><span class="line"><span class="cl">    <span class="n">unit_price</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 朝向</span>
</span></span><span class="line"><span class="cl">    <span class="n">orientation</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 楼层</span>
</span></span><span class="line"><span class="cl">    <span class="n">floor</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 装修</span>
</span></span><span class="line"><span class="cl">    <span class="n">decoration</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 总价</span>
</span></span><span class="line"><span class="cl">    <span class="n">total_price</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 小区</span>
</span></span><span class="line"><span class="cl">    <span class="n">community</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 建筑年代</span>
</span></span><span class="line"><span class="cl">    <span class="n">build_year</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 绿化率</span>
</span></span><span class="line"><span class="cl">    <span class="n">plant_rate</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 产权年限</span>
</span></span><span class="line"><span class="cl">    <span class="n">property_tenure</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 小区参考均价</span>
</span></span><span class="line"><span class="cl">    <span class="n">community_price</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 小区均价同比去年</span>
</span></span><span class="line"><span class="cl">    <span class="n">community_price_to_last_year</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 小区均价同比上月</span>
</span></span><span class="line"><span class="cl">    <span class="n">community_price_to_last_month</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 小区容积率</span>
</span></span><span class="line"><span class="cl">    <span class="n">community_volume_rate</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 小区总楼栋数</span>
</span></span><span class="line"><span class="cl">    <span class="n">community_total_building_num</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 小区总户数</span>
</span></span><span class="line"><span class="cl">    <span class="n">community_total_family_num</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 小区物业费用</span>
</span></span><span class="line"><span class="cl">    <span class="n">community_property_expenses</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 小区物业费用</span>
</span></span><span class="line"><span class="cl">    <span class="n">community_people_vehicles_depart</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="爬虫程序运行结果示例" class="headerLink">
    <a href="#%e7%88%ac%e8%99%ab%e7%a8%8b%e5%ba%8f%e8%bf%90%e8%a1%8c%e7%bb%93%e6%9e%9c%e7%a4%ba%e4%be%8b" class="header-mark"></a>爬虫程序运行结果示例</h3><h4 id="解析示例" class="headerLink">
    <a href="#%e8%a7%a3%e6%9e%90%e7%a4%ba%e4%be%8b" class="header-mark"></a>解析示例</h4><ul>
<li><strong>入口页解析示例</strong></li>
</ul>
<img src="MD_img/image-20220517104203697.png" alt="image-20220517104203697" style="zoom:67%;" />
<ul>
<li><strong>列表页解析示例</strong></li>
</ul>
<img src="MD_img/image-20220517104251707.png" alt="image-20220517104251707" style="zoom:67%;" />
<ul>
<li><strong>详情页解析示例</strong></li>
</ul>
<img src="MD_img/image-20220517104736217.png" alt="image-20220517104736217" style="zoom:67%;" />
<ul>
<li><strong>验证码通过示例</strong></li>
</ul>
<img src="MD_img/image-20220517200130646.png" alt="image-20220517200130646" style="zoom: 50%;" />
<ul>
<li><strong>OpenCV目标图像示例</strong></li>
</ul>
<img src="MD_img/iShot2022-05-09_16.40.32.png" alt="iShot2022-05-09_16.40.32" style="zoom:50%;" />
<center><img src="MD_img/image-20220511204336061.png" alt="image-20220511204336061" style="zoom: 80%;" /><img src="MD_img/6.png" alt="6" style="zoom:80%;" /><img src="MD_img/3.png" alt="3" style="zoom:80%;" /></center>
<h1 id="参考资料" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" class="header-mark"></a>参考资料</h1><ul>
<li><a href="https://www.bilibili.com/video/BV1jx411b7E3?p=1" target="_blank" rel="noopener noreffer">https://www.bilibili.com/video/BV1jx411b7E3?p=1</a></li>
</ul>
</div>

        <div class="sponsor">
        <div class="sponsor-avatar"><img
        class="lazyload"
        data-src="/images/logo.png"
        data-srcset="/images/logo.png, /images/logo.png 1.5x, /images/logo.png 2x"
        data-sizes="auto"
        alt="/images/logo.png"
        title="/images/logo.png"></div><p class="sponsor-bio"><em>如果你觉得这篇文章对你有所帮助，欢迎赞赏~</em></p><a href="/images/buymeacoffee.jpg" title="Sponsor" target="_blank" class="sponsor-button" rel="noopener noreferrer">
                <i class="far fa-heart fa-fw icon" style="color: #ec6cb9;"></i>
                <span>赞赏</span>
            </a></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-04-09</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/scrapy/index.md target="_blank" rel="noopener noreferrer">阅读原始文档</a>
                    </span><span>|&nbsp;<a class="link-to-report" href=https://github.com/dp0d/dp0d.github.io/issues/new?title=[bug]%20Scrapy%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E2%80%94%E2%80%94%E6%88%BF%E5%A4%A9%E4%B8%8B&body=|Field|Value|%0A|-|-|%0A|Title|Scrapy%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E2%80%94%E2%80%94%E6%88%BF%E5%A4%A9%E4%B8%8B|%0A|Url|https://dp0d.github.io/scrapy/|%0A|Filename|https://github.com/dp0d/dp0d.github.io/posts/2022/scrapy/index.md| target="_blank" rel="noopener noreferrer">报告问题</a>
                    </span></div>
            <div class="post-info-share">
                <span><a href="#" onclick="return false;" title="分享到 Twitter" data-sharer="twitter" data-url="https://dp0d.github.io/scrapy/" data-title="Scrapy实战案例——房天下" data-hashtags="Scrapy2.6"><i class="fab fa-twitter fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 Facebook" data-sharer="facebook" data-url="https://dp0d.github.io/scrapy/" data-hashtag="Scrapy2.6"><i class="fab fa-facebook-square fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 微博" data-sharer="weibo" data-url="https://dp0d.github.io/scrapy/" data-title="Scrapy实战案例——房天下"><i class="fab fa-weibo fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 Telegram" data-sharer="telegram" data-url="https://dp0d.github.io/scrapy/" data-title="Scrapy实战案例——房天下" data-web><i class="fab fa-telegram-plane fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/scrapy2.6/">Scrapy2.6</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/frp_by_docker/" class="prev" rel="prev" title="Linux下配置frp内网穿透"><i class="fas fa-angle-left fa-fw"></i>Linux下配置frp内网穿透</a>
            <a href="/lm_pretraining/" class="next" rel="next" title="语言模型预训练方法">语言模型预训练方法<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="giscus"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app/">giscus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/dp0d" target="_blank" rel="noopener noreferrer">dp0d</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp"><a href="https://beian.miit.gov.cn/" target="_blank">赣ICP备2022002313号-1</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div><script>
                    if('serviceWorker' in navigator) {
                        navigator.serviceWorker
                            .register('/sw.min.js', { scope: '/' })
                            .then(function(registration) {
                            });
                
                        navigator.serviceWorker
                            .ready
                            .then(function(registration) {
                            });
                    }
                </script></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="/lib/object-fit-images/ofi.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/fuse/fuse.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/topbar/topbar.min.js"></script><script type="text/javascript" src="/lib/pjax/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{"giscus":{"darkTheme":"dark","dataCategory":"General","dataCategoryId":"DIC_kwDOHB3uW84COZbL","dataEmitMetadata":"0","dataInputPosition":"top","dataLang":"zh-CN","dataMapping":"title","dataReactionsEnabled":"1","dataRepo":"dp0d/dp0d.github.io","dataRepoId":"R_kgDOHB3uWw","lightTheme":"light"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":true,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.1,"type":"fuse","useExtendedSearch":false},"sharerjs":true,"table":{"sort":true},"twemoji":true};</script><script type="text/javascript" src="/js/giscus.min.js" defer></script><script type="text/javascript" src="/lib/twemoji/twemoji.min.js" defer></script><script type="text/javascript" src="/js/twemoji.min.js" defer></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript></div>
</body>

</html>